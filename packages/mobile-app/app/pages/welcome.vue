<template>
  <div class="welcome-page">
    <!-- Welcome Screen -->
    <div v-if="currentScreen === 'welcome'" class="screen active">
      <div class="welcome-content">
        <div class="logo-section">
          <h1 class="game-title">ğŸ”¥ Ø§ÛŒÙ†ÙØ±Ù†Ø§Ù„ ğŸ”¥</h1>
          <p class="game-subtitle">Ø§ØªØ§Ù‚ ÙØ±Ø§Ø± Ù…Ø­ÛŒØ·ÛŒ</p>
          <p class="event-name">Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÙ‡Ø§ÛŒ ÙÚ©Ø±ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ù‡Ù†Ø±</p>
        </div>
        <button class="btn btn-primary" @click="currentScreen = 'tour'">Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ…!</button>
      </div>
    </div>

    <!-- Tour/Guide Screen -->
    <div v-else-if="currentScreen === 'tour'" class="screen active">
      <div class="tour-content">
        <h2>ğŸ® Ø¨Ø§Ø²ÛŒ Ú†Ù‡ Ø¬ÙˆØ±ÛŒÙ‡ØŸ</h2>
        
        <div class="tour-step">
          <div class="step-icon">ğŸ”</div>
          <h3>Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø²Ù„â€ŒÙ‡Ø§</h3>
          <p>ØªÙˆ Ù…Ø­ÛŒØ· Ø§Ø·Ø±Ø§ÙØª Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø¯Ù‡Ø§ÛŒ QR Ø¨Ú¯Ø±Ø¯</p>
        </div>

        <div class="tour-step">
          <div class="step-icon">ğŸ“±</div>
          <h3>Ø§Ø³Ú©Ù† Ú©Ø±Ø¯Ù†</h3>
          <p>Ù‡Ø± Ú©Ø¯ Ø±Ùˆ Ú©Ù‡ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØŒ ÛŒÙ‡ Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ù…ÛŒØ´Ù‡</p>
        </div>

        <div class="tour-step">
          <div class="step-icon">ğŸ§©</div>
          <h3>Ø­Ù„ Ù…Ø¹Ù…Ø§</h3>
          <p>Ù‡Ø± Ù¾Ø§Ø²Ù„ ÛŒÙ‡ Ù…Ø¹Ù…Ø§ÛŒ Ø¬Ø°Ø§Ø¨ Ø¯Ø§Ø±Ù‡ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø­Ù„Ø´ Ú©Ù†ÛŒ</p>
        </div>

        <div class="tour-step">
          <div class="step-icon">ğŸ†</div>
          <h3>Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ùˆ!</h3>
          <p>Ù‡Ù…Ù‡ Ù…Ø¹Ù…Ø§Ù‡Ø§Ø±Ùˆ Ø­Ù„ Ú©Ù† Ùˆ ÙØ§ØªØ­ Ø¨Ø§Ø²ÛŒ Ø¨Ø´Ùˆ!</p>
        </div>

        <div class="tour-navigation">
          <button class="btn btn-secondary" @click="currentScreen = 'welcome'">Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…</button>
          <button class="btn btn-primary" @click="currentScreen = 'auth-choice'">ÙÙ‡Ù…ÛŒØ¯Ù…ØŒ Ø¨Ø±ÛŒÙ…!</button>
        </div>
      </div>
    </div>

    <!-- Auth Choice Screen -->
    <div v-else-if="currentScreen === 'auth-choice'" class="screen active">
      <div class="auth-choice-content">
        <h2>Ø¨ÛŒØ§ ØªÙˆ Ø¨Ø§Ø²ÛŒ!</h2>
        <p class="subtitle">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ©ÛŒØ´Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:</p>
        
        <div class="auth-buttons">
          <button class="btn btn-primary btn-large" @click="currentScreen = 'registration'">
            <span class="btn-icon">ğŸ“</span>
            Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†Ù…
          </button>
          <button class="btn btn-secondary btn-large" @click="currentScreen = 'signin'">
            <span class="btn-icon">ğŸ”‘</span>
            Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù…
          </button>
        </div>

        <button class="btn-back" @click="currentScreen = 'tour'">â† Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…</button>
      </div>
    </div>

    <!-- Sign In Screen -->
    <div v-else-if="currentScreen === 'signin'" class="screen active">
      <div class="signin-content">
        <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
        
        <form @submit.prevent="handleSignIn" class="auth-form">
          <div class="form-group">
            <label for="signin-phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
            <input 
              v-model="signinPhone"
              type="tel" 
              id="signin-phone" 
              class="form-control" 
              placeholder="09xxxxxxxxx"
              required 
              maxlength="11" 
              pattern="^09\d{9}$"
            >
          </div>

          <button type="submit" class="btn btn-primary btn-large">Ø¨ÙØ±Ø³Øª Ø¨Ø±Ø§Ù… Ú©Ø¯ Ø¨ÛŒØ§Ø¯</button>
        </form>

        <button class="btn-back" @click="currentScreen = 'auth-choice'">â† Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…</button>
      </div>
    </div>

    <!-- OTP Verification Screen (for sign in) -->
    <div v-else-if="currentScreen === 'otp-signin'" class="screen active">
      <div class="otp-content">
        <h2>Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ùˆ Ø¨Ø²Ù†!</h2>
        <p class="subtitle">Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ú©Ù‡ Ø¨Ø±Ø§Øª ÙØ±Ø³ØªØ§Ø¯ÛŒÙ… Ø±Ùˆ Ø¨Ø²Ù† ({{ signinPhone }})</p>
        
        <div class="otp-inputs" role="group" aria-label="6-digit one-time passcode">
          <input 
            v-for="i in 6" 
            :key="i"
            v-model="otpDigits[i-1]"
            type="text" 
            class="otp-input" 
            maxlength="1" 
            pattern="\d" 
            inputmode="numeric"
            :aria-label="`OTP digit ${i}`"
            @input="handleOTPInput($event, i-1)"
            @keydown="handleOTPKeydown($event, i-1)"
          >
        </div>

        <button @click="verifySignInOTP" class="btn btn-primary btn-large">ØªØ§ÛŒÛŒØ¯ Ú©Ù†!</button>
        <button @click="resendOTP('signin')" class="btn btn-text">Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨ÙØ±Ø³Øª</button>

        <button class="btn-back" @click="currentScreen = 'signin'">â† Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…</button>
      </div>
    </div>

    <!-- Registration Screen -->
    <div v-else-if="currentScreen === 'registration'" class="screen active">
      <div class="registration-content">
        <h2>Ø«Ø¨Øª Ù†Ø§Ù…</h2>
        
        <form @submit.prevent="handleRegistration" class="auth-form">
          <!-- Name -->
          <div class="form-group">
            <label for="name">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ <span class="required">*</span></label>
            <input v-model="formData.name" type="text" id="name" class="form-control" required>
          </div>

          <!-- Profile Picture Upload -->
          <div class="form-group">
            <label for="profilePicture">ØªØµÙˆÛŒØ± Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
            <div class="profile-picture-upload">
              <div class="profile-preview" @click="$refs.profileInput?.click()">
                <img v-if="profilePicturePreview" :src="profilePicturePreview" alt="Profile Preview" />
                <span v-else class="placeholder-emoji">ğŸ‘¤</span>
              </div>
              <input 
                ref="profileInput"
                type="file" 
                id="profilePicture" 
                accept="image/*"
                @change="handleProfileUpload"
                style="display: none;"
              >
              <button type="button" class="btn btn-secondary btn-small" @click="$refs.profileInput?.click()">
                Ø§Ù†ØªØ®Ø§Ø¨ ØªØµÙˆÛŒØ±
              </button>
              <small class="help-text">Ø­Ø¯Ø§Ú©Ø«Ø± ÛµÛ°Û° Ú©ÛŒÙ„ÙˆØ¨Ø§ÛŒØª</small>
            </div>
          </div>

          <!-- Birthday -->
          <div class="form-group">
            <label for="birthday">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ <span class="required">*</span></label>
            <input v-model="formData.birthday" type="date" id="birthday" class="form-control" required>
          </div>

          <!-- Gender -->
          <div class="form-group">
            <label>Ø¬Ù†Ø³ÛŒØª <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-label">
                <input v-model="formData.gender" type="radio" name="gender" value="male" required>
                <span>Ù…Ø±Ø¯</span>
              </label>
              <label class="radio-label">
                <input v-model="formData.gender" type="radio" name="gender" value="female" required>
                <span>Ø²Ù†</span>
              </label>
              <label class="radio-label">
                <input v-model="formData.gender" type="radio" name="gender" value="other" required>
                <span>ØªØ±Ø¬ÛŒØ­ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ù†Ú¯ÙˆÛŒÙ…</span>
              </label>
            </div>
          </div>

          <!-- Education Level -->
          <div class="form-group">
            <label for="educationLevel">Ù…Ù‚Ø·Ø¹ ØªØ­ØµÛŒÙ„ÛŒ <span class="required">*</span></label>
            <select v-model="formData.educationLevel" id="educationLevel" class="form-control" required>
              <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
              <option value="high-school">Ø¯Ø¨ÛŒØ±Ø³ØªØ§Ù†</option>
              <option value="diploma">Ø¯ÛŒÙ¾Ù„Ù…</option>
              <option value="associate">Ú©Ø§Ø±Ø¯Ø§Ù†ÛŒ</option>
              <option value="bachelor">Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ</option>
              <option value="master">Ú©Ø§Ø±Ø´Ù†Ø§Ø³ÛŒ Ø§Ø±Ø´Ø¯</option>
              <option value="phd">Ø¯Ú©ØªØ±ÛŒ</option>
            </select>
          </div>

          <!-- Field of Study -->
          <div class="form-group">
            <label for="fieldOfStudy">Ø±Ø´ØªÙ‡ ØªØ­ØµÛŒÙ„ÛŒ <span class="required">*</span></label>
            <input v-model="formData.fieldOfStudy" type="text" id="fieldOfStudy" class="form-control" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±">
          </div>

          <!-- Phone Number -->
          <div class="form-group">
            <label for="phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ <span class="required">*</span></label>
            <input 
              v-model="formData.phone"
              type="tel" 
              id="phone" 
              class="form-control" 
              placeholder="09xxxxxxxxx"
              required 
              maxlength="11" 
              pattern="^09\d{9}$"
            >
          </div>

          <!-- Color Selection -->
          <div class="form-group">
            <label>Ø±Ù†Ú¯ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ <span class="required">*</span></label>
            <div class="color-picker">
              <input v-model="formData.color" type="radio" name="color" value="#ff6b6b" id="color1" required>
              <label for="color1" class="color-option" style="background: #ff6b6b;" aria-label="Red"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#4ecdc4" id="color2" required>
              <label for="color2" class="color-option" style="background: #4ecdc4;" aria-label="Teal"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#ffe66d" id="color3" required>
              <label for="color3" class="color-option" style="background: #ffe66d;" aria-label="Yellow"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#6c5ce7" id="color4" required>
              <label for="color4" class="color-option" style="background: #6c5ce7;" aria-label="Purple"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#fd79a8" id="color5" required>
              <label for="color5" class="color-option" style="background: #fd79a8;" aria-label="Pink"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#00b894" id="color6" required>
              <label for="color6" class="color-option" style="background: #00b894;" aria-label="Green"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#fdcb6e" id="color7" required>
              <label for="color7" class="color-option" style="background: #fdcb6e;" aria-label="Light Yellow"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#e17055" id="color8" required>
              <label for="color8" class="color-option" style="background: #e17055;" aria-label="Orange"></label>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-large">Ø¨Ø±ÛŒÙ… Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯!</button>
        </form>

        <button class="btn-back" @click="currentScreen = 'auth-choice'">â† Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…</button>
      </div>
    </div>

    <!-- OTP Verification Screen (for registration) -->
    <div v-else-if="currentScreen === 'otp-registration'" class="screen active">
      <div class="otp-content">
        <h2>Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ùˆ Ø¨Ø²Ù†!</h2>
        <p class="subtitle">Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ú©Ù‡ Ø¨Ø±Ø§Øª ÙØ±Ø³ØªØ§Ø¯ÛŒÙ… Ø±Ùˆ Ø¨Ø²Ù† ({{ formData.phone }})</p>
        
        <div class="otp-inputs" role="group" aria-label="6-digit one-time passcode">
          <input 
            v-for="i in 6" 
            :key="i"
            v-model="otpDigits[i-1]"
            type="text" 
            class="otp-input" 
            maxlength="1" 
            pattern="\d" 
            inputmode="numeric"
            :aria-label="`OTP digit ${i}`"
            @input="handleOTPInput($event, i-1)"
            @keydown="handleOTPKeydown($event, i-1)"
          >
        </div>

        <button @click="verifyRegistrationOTP" class="btn btn-primary btn-large">ØªØ§ÛŒÛŒØ¯ Ú©Ù† Ùˆ Ø¨Ø±ÛŒÙ…!</button>
        <button @click="resendOTP('registration')" class="btn btn-text">Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨ÙØ±Ø³Øª</button>

        <button class="btn-back" @click="currentScreen = 'registration'">â† Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…</button>
      </div>
    </div>

    <!-- Success Screen -->
    <div v-else-if="currentScreen === 'success'" class="screen active">
      <div class="success-content">
        <div class="success-icon">ğŸ‰</div>
        <h2>ÛŒÙ‡ Ø°Ù‡Ù†Ù…! Ø«Ø¨Øª Ù†Ø§Ù… Ø´Ø¯!</h2>
        
        <div class="player-info">
          <div class="player-id-card">
            <div class="player-avatar">
              <img v-if="profilePicturePreview" :src="profilePicturePreview" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
              <span v-else>ğŸ‘¤</span>
            </div>
            <div class="player-details">
              <h3>{{ formData.name }}</h3>
              <p class="player-label">Ú©Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†</p>
              <p class="player-id">{{ playerId }}</p>
            </div>
            <div class="player-color" :style="{ background: formData.color }"></div>
          </div>
        </div>

        <div class="instructions">
          <h3>ğŸ® Ø­Ø§Ù„Ø§ Ú†ÛŒÚ©Ø§Ø± Ú©Ù†ÛŒÙ…ØŸ</h3>
          <ul class="instruction-list">
            <li>ØªÙˆ Ù…Ø­ÛŒØ· Ø§Ø·Ø±Ø§ÙØª Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø¯Ù‡Ø§ÛŒ QR Ø¨Ú¯Ø±Ø¯</li>
            <li>Ù‡Ø± Ú©Ø¯ Ø±Ùˆ Ú©Ù‡ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØŒ ÛŒÙ‡ Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø² Ù…ÛŒØ´Ù‡</li>
            <li>Ù…Ø¹Ù…Ø§Ù‡Ø§Ø±Ùˆ Ø­Ù„ Ú©Ù† Ùˆ Ø§Ù…ØªÛŒØ§Ø² Ø¨Ú¯ÛŒØ±</li>
            <li>Ú©Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†Øª Ø±Ùˆ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù† Ú©Ù‡ Ø¨Ø¹Ø¯ Ù„Ø§Ø²Ù…Øª Ù…ÛŒØ´Ù‡</li>
          </ul>
        </div>

        <button class="btn btn-primary btn-large" @click="startGame">Ø¨Ø²Ù† Ø¨Ø±ÛŒÙ… Ø¨Ø§Ø²ÛŒ!</button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useApi } from '~/composables/useApi';

// Set page metadata
useHead({
  title: 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§ÛŒÙ†ÙØ±Ù†Ø§Ù„',
  meta: [
    { name: 'description', content: 'Ø§ÛŒÙ†ÙØ±Ù†Ø§Ù„ - Ø§ØªØ§Ù‚ ÙØ±Ø§Ø± Ù…Ø­ÛŒØ·ÛŒ - Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÙ‡Ø§ÛŒ ÙÚ©Ø±ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ù‡Ù†Ø±' }
  ]
});

const router = useRouter();
const api = useApi();

// State
const currentScreen = ref('welcome');
const signinPhone = ref('');
const playerId = ref('');
const profilePicturePreview = ref(null);
const otpDigits = ref(['', '', '', '', '', '']);

const formData = ref({
  name: '',
  birthday: '',
  gender: '',
  educationLevel: '',
  fieldOfStudy: '',
  phone: '',
  color: '',
  profilePicture: null
});

// Check if user is already logged in
onMounted(async () => {
  if (!process.client) return;

  const authToken = localStorage.getItem('auth-token');
  const cachedUser = localStorage.getItem('infernal-current-user');
  
  if (authToken && cachedUser) {
    try {
      const userData = JSON.parse(cachedUser);
      
      // Try to get fresh data from backend
      try {
        const response = await api.getUserProfile();
        if (response.success && response.user) {
          localStorage.setItem('infernal-current-user', JSON.stringify(response.user));
          router.push('/');
          return;
        }
      } catch (error) {
        console.warn('Could not verify user with backend, using cached data', error);
      }
      
      // Use cached data
      router.push('/');
      return;
    } catch (error) {
      console.error('Failed to parse user data:', error);
      localStorage.removeItem('auth-token');
      localStorage.removeItem('infernal-current-user');
    }
  }
});

// Handle profile picture upload
function handleProfileUpload(event) {
  const file = event.target.files?.[0];
  if (!file) return;
  
  // Validate file size (max 500KB)
  if (file.size > 500 * 1024) {
    alert('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² ÛµÛ°Û° Ú©ÛŒÙ„ÙˆØ¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯');
    event.target.value = '';
    return;
  }
  
  // Validate file type
  if (!file.type.startsWith('image/')) {
    alert('ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯');
    event.target.value = '';
    return;
  }
  
  // Read and preview the image
  const reader = new FileReader();
  reader.onload = (e) => {
    profilePicturePreview.value = e.target?.result;
    formData.value.profilePicture = e.target?.result;
  };
  reader.readAsDataURL(file);
}

// Validate phone number
function validatePhoneNumber(phone) {
  const phoneRegex = /^09\d{9}$/;
  return phoneRegex.test(phone);
}

// Handle sign in
async function handleSignIn() {
  if (!validatePhoneNumber(signinPhone.value)) {
    alert('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
    return;
  }

  try {
    const response = await api.sendOTP(signinPhone.value);
    if (response.success) {
      // Clear OTP digits and transition to OTP screen
      otpDigits.value = ['', '', '', '', '', ''];
      currentScreen.value = 'otp-signin';
    }
  } catch (error) {
    console.error('Error sending OTP:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯');
  }
}

// Handle OTP input
function handleOTPInput(event, index) {
  const value = event.target.value;
  
  // Only allow digits
  if (value && !/^\d$/.test(value)) {
    otpDigits.value[index] = '';
    return;
  }
  
  // Move to next input if value is entered
  if (value && index < 5) {
    const inputs = document.querySelectorAll('.otp-input');
    inputs[index + 1]?.focus();
  }
}

// Handle OTP keydown for backspace navigation
function handleOTPKeydown(event, index) {
  if (event.key === 'Backspace' && !otpDigits.value[index] && index > 0) {
    const inputs = document.querySelectorAll('.otp-input');
    inputs[index - 1]?.focus();
  }
}

// Verify sign in OTP
async function verifySignInOTP() {
  const otp = otpDigits.value.join('');
  
  if (otp.length !== 6) {
    alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ 6 Ø±Ù‚Ù…ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  try {
    const response = await api.verifyOTP(signinPhone.value, otp);
    if (response.success && response.token) {
      // Store auth token and user data
      if (process.client) {
        localStorage.setItem('auth-token', response.token);
        if (response.user) {
          localStorage.setItem('infernal-current-user', JSON.stringify(response.user));
        }
      }
      // Navigate to main game
      router.push('/');
    } else {
      alert('Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
      otpDigits.value = ['', '', '', '', '', ''];
    }
  } catch (error) {
    console.error('Error verifying OTP:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ú©Ø¯');
  }
}

// Verify registration OTP
async function verifyRegistrationOTP() {
  const otp = otpDigits.value.join('');
  
  if (otp.length !== 6) {
    alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ 6 Ø±Ù‚Ù…ÛŒ Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  try {
    const response = await api.verifyOTP(formData.value.phone, otp);
    if (response.success) {
      // Generate player ID
      playerId.value = `P${Date.now().toString().slice(-6)}`;
      
      const userData = {
        ...formData.value,
        playerId: playerId.value
      };
      
      // Store auth token and user data
      if (process.client) {
        if (response.token) {
          localStorage.setItem('auth-token', response.token);
        }
        localStorage.setItem('infernal-current-user', JSON.stringify(userData));
      }
      
      currentScreen.value = 'success';
    } else {
      alert('Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
      otpDigits.value = ['', '', '', '', '', ''];
    }
  } catch (error) {
    console.error('Error verifying OTP:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ§ÛŒÛŒØ¯ Ú©Ø¯');
  }
}

// Resend OTP
async function resendOTP(type) {
  const phone = type === 'signin' ? signinPhone.value : formData.value.phone;
  
  try {
    const response = await api.sendOTP(phone);
    if (response.success) {
      alert('Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
      otpDigits.value = ['', '', '', '', '', ''];
    }
  } catch (error) {
    console.error('Error resending OTP:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©Ø¯');
  }
}

// Handle registration
async function handleRegistration() {
  if (!validatePhoneNumber(formData.value.phone)) {
    alert('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
    return;
  }

  try {
    const response = await api.sendOTP(formData.value.phone);
    if (response.success) {
      // Clear OTP digits and transition to OTP screen
      otpDigits.value = ['', '', '', '', '', ''];
      currentScreen.value = 'otp-registration';
    }
  } catch (error) {
    console.error('Error sending OTP:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯');
  }
}

// Start game
function startGame() {
  router.push('/');
}
</script>

<style lang="scss" scoped>
@import '@/assets/scss/welcome.scss';

.welcome-page {
  width: 100%;
  min-height: 100vh;
  
  .screen {
    display: none;
    
    &.active {
      display: flex;
    }
  }
}
</style>
