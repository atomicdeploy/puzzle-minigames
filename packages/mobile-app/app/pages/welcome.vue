<template>
  <div class="welcome-page">
    <!-- Welcome Screen -->
    <div v-if="currentScreen === 'welcome'" class="screen active">
      <div class="welcome-content">
        <div class="logo-section">
          <h1 class="game-title">ğŸ”¥ Ø§ÛŒÙ†ÙØ±Ù†Ø§Ù„ ğŸ”¥</h1>
          <p class="game-subtitle">Ø§ØªØ§Ù‚ ÙØ±Ø§Ø± Ù…Ø­ÛŒØ·ÛŒ</p>
          <p class="event-name">Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÙ‡Ø§ÛŒ ÙÚ©Ø±ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ù‡Ù†Ø±</p>
        </div>
        <button class="btn btn-primary" @click="currentScreen = 'tour'">Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯</button>
      </div>
    </div>

    <!-- Tour/Guide Screen -->
    <div v-else-if="currentScreen === 'tour'" class="screen active">
      <div class="tour-content">
        <h2>ğŸ® Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¨Ø§Ø²ÛŒ</h2>
        
        <div class="tour-step">
          <div class="step-icon">ğŸ”</div>
          <h3>Ú©Ø´Ù Ù¾Ø§Ø²Ù„â€ŒÙ‡Ø§</h3>
          <p>Ø¯Ø± Ù…Ø­ÛŒØ· Ø§Ø·Ø±Ø§Ù Ø®ÙˆØ¯ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ QR Ú©Ø¯Ù‡Ø§ÛŒ Ù…Ø®ÙÛŒ Ø¨Ú¯Ø±Ø¯ÛŒØ¯</p>
        </div>

        <div class="tour-step">
          <div class="step-icon">ğŸ“±</div>
          <h3>Ø§Ø³Ú©Ù† Ú©Ø¯</h3>
          <p>Ø¨Ø§ Ø§Ø³Ú©Ù† QR Ú©Ø¯ØŒ Ù¾Ø§Ø²Ù„â€ŒÙ‡Ø§ÛŒ Ù¾Ù†Ù‡Ø§Ù† Ø±Ø§ Ú©Ø´Ù Ú©Ù†ÛŒØ¯</p>
        </div>

        <div class="tour-step">
          <div class="step-icon">ğŸ§©</div>
          <h3>Ø­Ù„ Ù…Ø¹Ù…Ø§</h3>
          <p>Ù‡Ø± Ù¾Ø§Ø²Ù„ ÛŒÚ© Ù…Ø¹Ù…Ø§ÛŒ Ø¬Ø°Ø§Ø¨ Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø­Ù„ Ú©Ù†ÛŒØ¯</p>
        </div>

        <div class="tour-step">
          <div class="step-icon">ğŸ†</div>
          <h3>Ø¨Ø±Ù†Ø¯Ù‡ Ø´ÙˆÛŒØ¯</h3>
          <p>Ø¨Ø§ Ø­Ù„ Ù‡Ù…Ù‡ Ù…Ø¹Ù…Ø§Ù‡Ø§ØŒ ÙØ§ØªØ­ Ø¨Ø§Ø²ÛŒ Ø´ÙˆÛŒØ¯!</p>
        </div>

        <div class="tour-navigation">
          <button class="btn btn-secondary" @click="currentScreen = 'welcome'">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
          <button class="btn btn-primary" @click="currentScreen = 'auth-choice'">Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…</button>
        </div>
      </div>
    </div>

    <!-- Auth Choice Screen -->
    <div v-else-if="currentScreen === 'auth-choice'" class="screen active">
      <div class="auth-choice-content">
        <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</h2>
        <p class="subtitle">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
        
        <div class="auth-buttons">
          <button class="btn btn-primary btn-large" @click="currentScreen = 'registration'">
            <span class="btn-icon">ğŸ“</span>
            Ø«Ø¨Øª Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯
          </button>
          <button class="btn btn-secondary btn-large" @click="currentScreen = 'signin'">
            <span class="btn-icon">ğŸ”‘</span>
            ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
          </button>
        </div>

        <button class="btn-back" @click="currentScreen = 'tour'">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </div>
    </div>

    <!-- Sign In Screen -->
    <div v-else-if="currentScreen === 'signin'" class="screen active">
      <div class="signin-content">
        <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</h2>
        
        <form @submit.prevent="handleSignIn" class="auth-form">
          <div class="form-group">
            <label for="signin-phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
            <input 
              v-model="signinPhone"
              type="tel" 
              id="signin-phone" 
              class="form-control" 
              placeholder="09xxxxxxxxx"
              required 
              maxlength="11" 
              pattern="^09\d{9}$"
            >
          </div>

          <button type="submit" class="btn btn-primary btn-large">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
        </form>

        <button class="btn-back" @click="currentScreen = 'auth-choice'">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </div>
    </div>

    <!-- Registration Screen -->
    <div v-else-if="currentScreen === 'registration'" class="screen active">
      <div class="registration-content">
        <h2>Ø«Ø¨Øª Ù†Ø§Ù…</h2>
        
        <form @submit.prevent="handleRegistration" class="auth-form">
          <!-- Name -->
          <div class="form-group">
            <label for="name">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ <span class="required">*</span></label>
            <input v-model="formData.name" type="text" id="name" class="form-control" required>
          </div>

          <!-- Birthday -->
          <div class="form-group">
            <label for="birthday">ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ <span class="required">*</span></label>
            <input v-model="formData.birthday" type="date" id="birthday" class="form-control" required>
          </div>

          <!-- Gender -->
          <div class="form-group">
            <label>Ø¬Ù†Ø³ÛŒØª <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-label">
                <input v-model="formData.gender" type="radio" name="gender" value="male" required>
                <span>Ù…Ø±Ø¯</span>
              </label>
              <label class="radio-label">
                <input v-model="formData.gender" type="radio" name="gender" value="female" required>
                <span>Ø²Ù†</span>
              </label>
              <label class="radio-label">
                <input v-model="formData.gender" type="radio" name="gender" value="other" required>
                <span>ØªØ±Ø¬ÛŒØ­ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ù†Ú¯ÙˆÛŒÙ…</span>
              </label>
            </div>
          </div>

          <!-- Phone Number -->
          <div class="form-group">
            <label for="phone">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ <span class="required">*</span></label>
            <input 
              v-model="formData.phone"
              type="tel" 
              id="phone" 
              class="form-control" 
              placeholder="09xxxxxxxxx"
              required 
              maxlength="11" 
              pattern="^09\d{9}$"
            >
          </div>

          <!-- Color Selection -->
          <div class="form-group">
            <label>Ø±Ù†Ú¯ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ <span class="required">*</span></label>
            <div class="color-picker">
              <input v-model="formData.color" type="radio" name="color" value="#ff6b6b" id="color1" required>
              <label for="color1" class="color-option" style="background: #ff6b6b;" aria-label="Red"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#4ecdc4" id="color2" required>
              <label for="color2" class="color-option" style="background: #4ecdc4;" aria-label="Teal"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#ffe66d" id="color3" required>
              <label for="color3" class="color-option" style="background: #ffe66d;" aria-label="Yellow"></label>
              
              <input v-model="formData.color" type="radio" name="color" value="#6c5ce7" id="color4" required>
              <label for="color4" class="color-option" style="background: #6c5ce7;" aria-label="Purple"></label>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-large">Ø§Ø¯Ø§Ù…Ù‡</button>
        </form>

        <button class="btn-back" @click="currentScreen = 'auth-choice'">â† Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </div>
    </div>

    <!-- Success Screen -->
    <div v-else-if="currentScreen === 'success'" class="screen active">
      <div class="success-content">
        <div class="success-icon">ğŸ‰</div>
        <h2>Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</h2>
        
        <div class="player-info">
          <div class="player-id-card">
            <div class="player-avatar">ğŸ‘¤</div>
            <div class="player-details">
              <h3>{{ formData.name }}</h3>
              <p class="player-label">Ú©Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù†</p>
              <p class="player-id">{{ playerId }}</p>
            </div>
            <div class="player-color" :style="{ background: formData.color }"></div>
          </div>
        </div>

        <div class="instructions">
          <h3>ğŸ® Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</h3>
          <ul class="instruction-list">
            <li>Ø¯Ø± Ù…Ø­ÛŒØ· Ø§Ø·Ø±Ø§Ù Ø®ÙˆØ¯ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ QR Ú©Ø¯Ù‡Ø§ÛŒ Ù…Ø®ÙÛŒ Ø¨Ú¯Ø±Ø¯ÛŒØ¯</li>
            <li>Ø¨Ø§ Ø§Ø³Ú©Ù† Ù‡Ø± QR Ú©Ø¯ØŒ ÛŒÚ© Ù¾Ø§Ø²Ù„ Ø¬Ø¯ÛŒØ¯ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
            <li>Ù…Ø¹Ù…Ø§Ù‡Ø§ÛŒ Ù‡Ø± Ù¾Ø§Ø²Ù„ Ø±Ø§ Ø­Ù„ Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ù…ØªÛŒØ§Ø² Ú©Ø³Ø¨ Ú©Ù†ÛŒØ¯</li>
            <li>Ú©Ø¯ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø¹Ø¯ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ú©Ù†ÛŒØ¯</li>
          </ul>
        </div>

        <button class="btn btn-primary btn-large" @click="startGame">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useApi } from '~/composables/useApi';

// Set page metadata
useHead({
  title: 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§ÛŒÙ†ÙØ±Ù†Ø§Ù„',
  meta: [
    { name: 'description', content: 'Ø§ÛŒÙ†ÙØ±Ù†Ø§Ù„ - Ø§ØªØ§Ù‚ ÙØ±Ø§Ø± Ù…Ø­ÛŒØ·ÛŒ - Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒÙ‡Ø§ÛŒ ÙÚ©Ø±ÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ Ù‡Ù†Ø±' }
  ]
});

const router = useRouter();
const api = useApi();

// State
const currentScreen = ref('welcome');
const signinPhone = ref('');
const playerId = ref('');

const formData = ref({
  name: '',
  birthday: '',
  gender: '',
  phone: '',
  color: ''
});

// Check if user is already logged in
onMounted(async () => {
  if (!process.client) return;

  const authToken = localStorage.getItem('auth-token');
  const cachedUser = localStorage.getItem('infernal-current-user');
  
  if (authToken && cachedUser) {
    try {
      const userData = JSON.parse(cachedUser);
      
      // Try to get fresh data from backend
      try {
        const response = await api.getUserProfile();
        if (response.success && response.user) {
          localStorage.setItem('infernal-current-user', JSON.stringify(response.user));
          router.push('/');
          return;
        }
      } catch (error) {
        console.warn('Could not verify user with backend, using cached data', error);
      }
      
      // Use cached data
      router.push('/');
      return;
    } catch (error) {
      console.error('Failed to parse user data:', error);
      localStorage.removeItem('auth-token');
      localStorage.removeItem('infernal-current-user');
    }
  }
});

// Validate phone number
function validatePhoneNumber(phone) {
  const phoneRegex = /^09\d{9}$/;
  return phoneRegex.test(phone);
}

// Handle sign in
async function handleSignIn() {
  if (!validatePhoneNumber(signinPhone.value)) {
    alert('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
    return;
  }

  try {
    const response = await api.sendOTP(signinPhone.value);
    if (response.success) {
      // In a real app, would show OTP screen
      // For now, just log success
      console.log('OTP sent successfully');
      alert('Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ)');
    }
  } catch (error) {
    console.error('Error sending OTP:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯');
  }
}

// Handle registration
async function handleRegistration() {
  if (!validatePhoneNumber(formData.value.phone)) {
    alert('Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª');
    return;
  }

  try {
    // Generate a simple player ID (in production this would come from backend)
    playerId.value = `P${Date.now().toString().slice(-6)}`;
    
    const userData = {
      ...formData.value,
      playerId: playerId.value
    };

    // In a real app, would send to backend
    // For now, store locally
    if (process.client) {
      localStorage.setItem('infernal-current-user', JSON.stringify(userData));
      localStorage.setItem('auth-token', 'demo-token');
    }
    
    currentScreen.value = 'success';
  } catch (error) {
    console.error('Error during registration:', error);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…');
  }
}

// Start game
function startGame() {
  router.push('/');
}
</script>

<style lang="scss" scoped>
@import '@/assets/scss/welcome.scss';

.welcome-page {
  width: 100%;
  min-height: 100vh;
  
  .screen {
    display: none;
    
    &.active {
      display: flex;
    }
  }
}
</style>
